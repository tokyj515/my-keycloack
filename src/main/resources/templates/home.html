<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <title>Home</title>
</head>
<script th:inline="javascript">
  let sessionExpiryTime = /*[[${sessionExpiryTime}]]*/ 0; // 백엔드에서 제공하는 만료 시간
  sessionExpiryTime = Number(sessionExpiryTime); // 안전한 숫자 변환
  let timer = isNaN(sessionExpiryTime) ? 0 : sessionExpiryTime; // NaN 방지

  function updateTimer() {
    if (timer <= 0) {
      document.getElementById('session-expiry').textContent = 'Session Expired';
      alert('Your session has expired. Please log in again.');
      window.location.href = '/logout';
    } else {
      document.getElementById('session-expiry').textContent = `${timer} seconds`;
      timer--;
    }
  }

  setInterval(updateTimer, 1000); // 1초마다 타이머 갱신
</script>

<body>
<h1>Welcome to the Home Page</h1>

<div th:if="${username}">
  <p>Hello, <span th:text="${username}"></span>!</p>
  <p>Your Access Token: <span th:text="${accessToken}">[Access Token]</span></p>

  <div th:if="${#authentication}">
    <p>Your Roles: <span th:text="${#authentication.authorities}"></span></p>
  </div>


  <p>Your Session Expires In: <span id="session-expiry"></span> seconds</p>
  <form action="/refresh-token" method="post">
    <button type="submit">Extend Session</button>
  </form>

  <br>
  <br>
  <br>

  <!-- Log out 버튼 -->
  <form action="/logout" method="post">
    <button type="submit">Log out</button>
  </form>

  <!-- 관리자 페이지 링크 (LV1 권한 필요) -->
  <div sec:authorize="hasAuthority('ROLE_LV1')">
    <a href="/admin">Go to Admin Page</a>
  </div>

  <!-- 사용자 페이지 링크 (모든 인증 사용자 접근 가능) -->
  <div sec:authorize="isAuthenticated()">
    <a href="/user">Go to User Page</a>
  </div>

  <div sec:authorize="isAuthenticated()">
    <a href="/session-info">session-info</a>
  </div>
</div>

<div th:if="${username == null}">
  <p>You are not logged in. Please <a href="http://localhost:8000/oauth2/authorization/keycloak">log in</a>.</p>
</div>

<!--<a href="/register">Sign up</a>-->
</body>
</html>
